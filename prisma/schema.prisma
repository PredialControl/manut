// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  role          String    // ADMIN, MANAGER, TECHNICIAN, CLIENT
  contract      Contract? @relation(fields: [contractId], references: [id])
  contractId    String?
  executions    Execution[]
  tickets       Ticket[]
  userContracts UserContract[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Contract {
  id        String    @id @default(cuid())
  name      String
  acronym   String?   @unique
  cnpj      String?
  address   String?
  sindico   String?   // Gestor
  phone     String?   // Telefone
  status    String?
  imageUrl  String?   // Caminho para a imagem do contrato
  type      String    @default("MAINTENANCE") // MAINTENANCE, TICKETS, RONDA, MIXED
  deleted   Boolean   @default(false)
  // Campos do App Ronda
  periodicidade     String?   // DIARIA, SEMANAL, QUINZENAL, MENSAL, etc.
  tipoUso           String?   // RESIDENCIAL, NAO_RESIDENCIAL, RESIDENCIAL_E_NAO_RESIDENCIAL
  quantidadeTorres  Int?
  observacoes       String?
  supabaseId        String?   @unique // ID do contrato no Supabase para vincular
  users     User[]
  buildings Building[]
  constructionItems ConstructionItem[]
  tickets   Ticket[]
  userContracts UserContract[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deleted])
  @@index([type])
  @@index([supabaseId])
}

model Building {
  id          String   @id @default(cuid())
  name        String
  address     String?
  contract    Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  contractId  String
  floors      Floor[]
  tickets     Ticket[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([contractId])
}

model Floor {
  id        String     @id @default(cuid())
  name      String
  building  Building   @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  buildingId String
  locations Location[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Location {
  id        String   @id @default(cuid())
  name      String
  floor     Floor    @relation(fields: [floorId], references: [id], onDelete: Cascade)
  floorId   String
  assets    Asset[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Asset {
  id              String           @id @default(cuid())
  name            String
  location        Location         @relation(fields: [locationId], references: [id], onDelete: Cascade)
  locationId      String
  status          String           @default("ATIVO")
  tag             String?
  model           String?          // Modelo do equipamento
  manufacturer    String?          // Fabricante
  quantity        Int?             @default(1) // Quantidade
  type            String?          // Tipo/Categoria do equipamento
  imageUrl        String?          // Caminho para a imagem do ativo
  qrCode          String?          // Armazenar QR code em base64 ou URL
  preventiveTasks PreventiveTask[]
  correctiveCalls CorrectiveCall[]
  reports         Report[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model CorrectiveCall {
  id          String     @id @default(cuid())
  omcNumber   String?    @unique // Ordem de Manutenção Corretiva
  title       String
  description String?
  priority    String     // Era Priority
  status      String     // Era Status
  asset       Asset?     @relation(fields: [assetId], references: [id])
  assetId     String?
  originTicket Ticket?   // Ticket que originou essa OMC
  executions  Execution[]
  attachments Attachment[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model PreventiveTask {
  id          String     @id @default(cuid())
  ompNumber   String?    @unique // Ordem de Manutenção
  description String
  frequency   String     // Era Frequency
  startDate   DateTime
  checklist   String?    // Armazenado como JSON string
  asset       Asset      @relation(fields: [assetId], references: [id])
  assetId     String
  executions  Execution[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Execution {
  id               String          @id @default(cuid())
  description      String
  user             User            @relation(fields: [userId], references: [id])
  userId           String
  correctiveCall   CorrectiveCall? @relation(fields: [correctiveCallId], references: [id])
  correctiveCallId String?
  preventiveTask   PreventiveTask? @relation(fields: [preventiveTaskId], references: [id])
  preventiveTaskId String?
  attachments      Attachment[]
  reports          Report[]
  startTime        DateTime? // Substitui executedAt
  endTime          DateTime? // Novo campo para o término
  checklistResults String?    // Armazenado como JSON string
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
}

model Report {
  id          String    @id @default(cuid())
  name        String
  url         String
  asset       Asset?    @relation(fields: [assetId], references: [id])
  assetId     String?
  execution   Execution? @relation(fields: [executionId], references: [id])
  executionId String?
  issuedAt    DateTime
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Attachment {
  id               String          @id @default(cuid())
  url              String
  correctiveCall   CorrectiveCall? @relation(fields: [correctiveCallId], references: [id])
  correctiveCallId String?
  execution        Execution?      @relation(fields: [executionId], references: [id])
  executionId      String?
  createdAt        DateTime        @default(now())
}

// Modelos para Planos de Manutenção Padrão
model MaintenancePlan {
  id          String                    @id @default(cuid())
  acronym     String                    @unique // Ex: 'BMB-REC'
  description String                    // Ex: 'Bomba de recalque'
  category    String                    
  tasks       MaintenanceTaskTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MaintenanceTaskTemplate {
  id          String   @id @default(cuid())
  sistema     String   // Sistema (ex: 'Sistema Hidráulico', 'Sistema Elétrico')
  atividade   String   // Atividade (ex: 'Verificar pressão', 'Limpar filtros')
  periodicidade String // Periodicidade (ex: 'Mensal', 'Semanal', 'Trimestral')
  responsavel String   // Responsável (ex: 'Técnico', 'Operador')
  plan        MaintenancePlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  planId      String
  checklist   ChecklistItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChecklistItem {
  id          String   @id @default(cuid())
  description String
  task        MaintenanceTaskTemplate @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Modelo para Itens/Chamados da Construtora
model ConstructionItem {
  id          String   @id @default(cuid())
  number      String   @unique // Número do chamado (ex: 72246)
  description String   // Pendência/Descrição
  status      String   // Situação (EM_ANDAMENTO, FINALIZADO, IMPROCEDENTE, AGUARDANDO_VISTORIA, CONCLUIDO)
  especialidade String? // Especialidade (CIVIL, ELETRICA, HIDRAULICA, SISTEMAS)
  openedAt    DateTime // Data de abertura
  deadline    DateTime? // Prazo
  rescheduledDate DateTime? // Data reprogramação
  feedback    String?  // Retorno/Observações
  contract    Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  contractId  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contractId])
  @@index([status])
  @@index([especialidade])
}

// ============================================
// MÓDULO CHAMADOS - Novos Modelos
// ============================================

// Relacionamento Usuário-Contrato com Permissões
model UserContract {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  contractId String

  // Permissões por módulo
  canAccessPreventive   Boolean @default(false)
  canAccessCorrective   Boolean @default(false)
  canAccessTickets      Boolean @default(false)
  canAccessRondas       Boolean @default(false)
  canAccessReports      Boolean @default(false)

  // Permissões específicas de buildings (para Chamados)
  allowedBuildings String[] @default([]) // Array de IDs de prédios

  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, contractId])
  @@index([userId])
  @@index([contractId])
}

// Tickets/Chamados (integra com CorrectiveCall)
model Ticket {
  id                String   @id @default(cuid())
  number            String?  @unique // Número externo do ticket

  building          Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  buildingId        String

  user              User     @relation(fields: [userId], references: [id])
  userId            String

  contract          Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  contractId        String

  location          String   // Local específico dentro do prédio
  description       String
  photoUrls         String[] @default([]) // Array de URLs de fotos

  status            String   // itens_apontados, em_andamento, improcedente, aguardando_vistoria, concluido, f_indevido
  priority          String?  // BAIXA, MEDIA, ALTA, URGENTE
  responsible       String?  // Condomínio, Construtora

  deadline          DateTime?
  reprogrammingDate DateTime?
  reprogrammingHistory String? // JSON com histórico de reprogramações

  constructorReturn String?  // Feedback/retorno da construtora

  // INTEGRAÇÃO COM CORRETIVAS
  correctiveCall    CorrectiveCall? @relation(fields: [correctiveCallId], references: [id])
  correctiveCallId  String? @unique

  isRegistered      Boolean @default(false) // Indica se foi convertido em OMC

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([contractId])
  @@index([buildingId])
  @@index([userId])
  @@index([status])
  @@index([responsible])
}
